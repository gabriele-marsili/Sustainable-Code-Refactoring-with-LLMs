CXX = g++
CXXFLAGS = -std=c++17 -I src -I test -I /usr/local/include -I/usr/include/boost
BOOST_LDFLAGS = -L/usr/lib/x86_64-linux-gnu -lboost_unit_test_framework
CATCH_LDFLAGS = 

# Source and test files
SRC_FILES = $(wildcard src/*.cpp)
TEST_FILES = $(wildcard test/*.cpp)

# Object files
SRC_OBJ = $(patsubst src/%.cpp, obj/%.o, $(SRC_FILES))
TEST_OBJ = $(patsubst test/%.cpp, obj/%.o, $(TEST_FILES))

# Eseguibile di test
TARGET = test_exec

# Directory per gli object files
OBJ_DIR = obj

# Detect test framework
CATCH_TEST := $(shell grep -l "catch.hpp\|catch2.hpp\|catch2/catch.hpp\|catch_amalgamated.hpp" test/*.cpp 2>/dev/null || true)
BOOST_TEST := $(shell grep -l "boost/test\|BOOST_TEST" test/*.cpp 2>/dev/null || true)

.PHONY: all clean detect-framework

all: detect-framework $(TARGET)

detect-framework:
	@echo "üîç Rilevamento framework di test..."
ifneq ($(CATCH_TEST),)
	@echo "üìã Rilevato Catch2 test framework"
	$(eval CXXFLAGS += -DUSE_CATCH2)
	$(eval LDFLAGS = $(CATCH_LDFLAGS))
else ifneq ($(BOOST_TEST),)
	@echo "üöÄ Rilevato Boost.Test framework"  
	$(eval CXXFLAGS += -DBOOST_TEST_DYN_LINK)
	$(eval LDFLAGS = $(BOOST_LDFLAGS))
else
	@echo "‚ö†Ô∏è  Nessun framework di test rilevato, uso Boost come default"
	$(eval CXXFLAGS += -DBOOST_TEST_DYN_LINK)
	$(eval LDFLAGS = $(BOOST_LDFLAGS))
endif

# Creazione della directory degli object files se non esiste
$(OBJ_DIR):
	mkdir -p $(OBJ_DIR)

$(TARGET): $(OBJ_DIR) $(SRC_OBJ) $(TEST_OBJ)
	@echo "üß™ Compilando l'eseguibile di test..."
ifneq ($(CATCH_TEST),)
	@echo "üîó Linking con Catch2..."
	# Se usiamo Catch2, includiamo catch_main.cpp se esiste
	@if [ -f "catch_main.cpp" ]; then \
		echo "üìÑ Compilando catch_main.cpp..."; \
		$(CXX) $(CXXFLAGS) -c catch_main.cpp -o obj/catch_main.o; \
		$(CXX) $(CXXFLAGS) $(SRC_OBJ) $(TEST_OBJ) obj/catch_main.o -o $@ $(LDFLAGS); \
	else \
		$(CXX) $(CXXFLAGS) $(SRC_OBJ) $(TEST_OBJ) -o $@ $(LDFLAGS); \
	fi
else
	@echo "üîó Linking con Boost.Test..."
	# Usa -lboost_unit_test_framework per linkare la libreria.
	# Aggiungi -L/usr/lib/x86_64-linux-gnu per specificare esplicitamente il percorso della libreria Boost.
	$(CXX) $(CXXFLAGS) -o $@ $(SRC_OBJ) $(TEST_OBJ) $(LDFLAGS)
endif

$(OBJ_DIR)/%.o: src/%.cpp
	@echo "üî® Compilando $<..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(OBJ_DIR)/%.o: test/%.cpp
	@echo "üî® Compilando $<..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

clean:
	rm -f src/*.o test/*.o $(TARGET)
	rm -rf $(OBJ_DIR)